name: Deploy to Simply.com (MSDeploy)

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  DOTNET_VERSION: "8.0.x"
  PROJECT_PATH: "SeriousSez.Api/SeriousSez.Api.csproj"
  PUBLISH_PATH: "./publish"
  RUNTIME_IDENTIFIER: "win-x64"
  NODE_VERSION: "20.x"
  ANGULAR_WORKING_DIR: "./SeriousSez"
  ANGULAR_DIST_PATH: "./SeriousSez/dist/SeriousSez/browser"
  API_HEALTH_URL: "https://recipes.api.sezginsahin.dk/api/health/ping"
  WEB_HEALTH_URL: "https://recipes.sezginsahin.dk/"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.changes.outputs.api }}
      web: ${{ steps.changes.outputs.web }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            api:
              - 'SeriousSez.Api/**'
            web:
              - 'SeriousSez/**'
              - '!SeriousSez.Api/**'

  build-api:
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    outputs:
      publish-path: ${{ steps.publish.outputs.publish_path || env.PUBLISH_PATH }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Generate production appsettings from secrets
        working-directory: ./SeriousSez.Api
        shell: pwsh
        env:
          MYSQL_CONNECTION_STRING: ${{ secrets.MYSQL_CONNECTION_STRING }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          $required = @(
            @{ Name = 'MYSQL_CONNECTION_STRING'; Value = $env:MYSQL_CONNECTION_STRING }
          )

          $missing = $required | Where-Object { -not $_.Value }
          if ($missing) {
            throw "Missing required secrets: $($missing.Name -join ', ')"
          }

          $aiProvider = if ([string]::IsNullOrWhiteSpace($env:OPENAI_API_KEY)) { "Wikipedia" } else { "OpenAI" }

          $config = @{
            ConnectionStrings = @{
              MySql = $env:MYSQL_CONNECTION_STRING
              AzureStorage = $env:AZURE_STORAGE_CONNECTION_STRING
            }
            Logging = @{
              LogLevel = @{
                Default = 'Information'
                Microsoft = 'Warning'
                'Microsoft.Hosting.Lifetime' = 'Information'
              }
            }
            JWTSettings = @{
              securityKey = "SeriousSezSecretKey 85738a5f-871a-4cd1-a03c-bfdfa352d3d2"
              validIssuer = "SeriousSez"
              validAudience = "https://recipes.api.sezginsahin.dk/"
              expiryInMinutes = 60
            }
            AIImageGeneration = @{
              Enabled = $true
              Provider = $aiProvider
              OpenAIApiKey = $env:OPENAI_API_KEY
              OpenAIEndpoint = "https://api.openai.com/v1/images/edits"
              OpenAIGenerationEndpoint = "https://api.openai.com/v1/images/generations"
              OpenAIUseEdits = $false
              OpenAIModel = "gpt-image-1"
              OpenAIImageSize = "1024x1024"
              OpenAIStylePrompt = "hand-drawn cross-hatching ink sketch, vintage packaging drawing, monochrome pen art, minimal color, clean white background"
              OpenAIFallbackModels = "dall-e-2"
              StableDiffusionEndpoint = "http://127.0.0.1:7860"
              StyleReferenceImagePath = "..\\SeriousSez\\src\\assets\\images\\milk.jpg"
            }
            AllowedHosts = '*'
          }

          $json = $config | ConvertTo-Json -Depth 5
          Set-Content -Path 'appsettings.Production.json' -Value $json -Encoding UTF8

      - name: Restore and build API
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore

      - name: Publish API
        id: publish
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            --configuration Release `
            --runtime ${{ env.RUNTIME_IDENTIFIER }} `
            --self-contained true `
            --output ${{ env.PUBLISH_PATH }}
          echo "publish_path=${{ env.PUBLISH_PATH }}" >> $env:GITHUB_OUTPUT

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-publish
          path: ${{ env.PUBLISH_PATH }}/

  build-web:
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.ANGULAR_WORKING_DIR }}/package-lock.json

      - name: Install Angular dependencies
        working-directory: ${{ env.ANGULAR_WORKING_DIR }}
        run: npm ci

      - name: Inject Google Maps API key
        working-directory: ${{ env.ANGULAR_WORKING_DIR }}
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets['GOOGLE_MAPS_API_KEY'] }}
        shell: pwsh
        run: |
          (Get-Content src/environments/environment.prod.ts) -replace '\$\{GOOGLE_MAPS_API_KEY\}', $env:GOOGLE_MAPS_API_KEY | Set-Content src/environments/environment.prod.ts

      - name: Build Angular app
        working-directory: ${{ env.ANGULAR_WORKING_DIR }}
        run: npm run build-prod

      - name: Ensure Angular web.config is present
        working-directory: ${{ env.ANGULAR_WORKING_DIR }}
        shell: pwsh
        run: |
          $dist = Join-Path "dist/SeriousSez/browser" "web.config"
          if (-not (Test-Path $dist)) {
            Copy-Item "src/web.config" $dist -Force
          }

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: ${{ env.ANGULAR_DIST_PATH }}/

  deploy-api:
    runs-on: windows-latest
    needs: [detect-changes, build-api]
    if: needs.detect-changes.outputs.api == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: api-publish
          path: ${{ env.PUBLISH_PATH }}/

      - name: Harden web.config for production startup
        shell: pwsh
        run: |
          $webConfig = Join-Path "${{ env.PUBLISH_PATH }}" "web.config"
          if (Test-Path $webConfig) {
            (Get-Content $webConfig -Raw) -replace 'stdoutLogEnabled="true"', 'stdoutLogEnabled="false"' | Set-Content $webConfig -Encoding UTF8
          }

          $logsDir = Join-Path "${{ env.PUBLISH_PATH }}" "logs"
          if (-not (Test-Path $logsDir)) {
            New-Item -ItemType Directory -Path $logsDir | Out-Null
          }

          $placeholder = Join-Path $logsDir ".keep"
          if (-not (Test-Path $placeholder)) {
            Set-Content -Path $placeholder -Value "keep" -Encoding UTF8
          }

      - name: Create app_offline.htm
        shell: pwsh
        run: |
          $content = @"
          <!DOCTYPE html>
          <html>
          <head>
              <title>Application Offline</title>
          </head>
          <body>
              <h1>Application Offline</h1>
              <p>The application is currently offline for maintenance.</p>
          </body>
          </html>
          "@
          Set-Content -Path "${{ env.PUBLISH_PATH }}/app_offline.htm" -Value $content

      - name: Deploy app_offline.htm to take app offline
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ${{ env.PUBLISH_PATH }}/
          server-dir: /recipes.api/
          dangerous-clean-slate: false

      - name: Wait for app to go offline
        shell: pwsh
        run: Start-Sleep -Seconds 3

      - name: Deploy API using FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ${{ env.PUBLISH_PATH }}/
          server-dir: /recipes.api/
          dangerous-clean-slate: false

      - name: Remove app_offline.htm from local publish folder
        shell: pwsh
        run: |
          Remove-Item "${{ env.PUBLISH_PATH }}/app_offline.htm" -Force -ErrorAction SilentlyContinue
          Write-Host "Removed app_offline.htm from local folder"

      - name: Deploy to remove app_offline.htm from server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ${{ env.PUBLISH_PATH }}/
          server-dir: /recipes.api/
          dangerous-clean-slate: true

      - name: Wait for app to restart
        shell: pwsh
        run: Start-Sleep -Seconds 15

      # - name: Health check API
      #   id: health_check
      #   continue-on-error: true
      #   shell: pwsh
      #   run: |
      #     if ([string]::IsNullOrWhiteSpace($env:API_HEALTH_URL)) {
      #       Write-Error "API_HEALTH_URL is not set"
      #     }
      #     Write-Host "Checking API health..."
      #     Start-Sleep -Seconds 5

      #     $retries = 5
      #     for ($i=1; $i -le $retries; $i++) {
      #       try {
      #         $resp = Invoke-WebRequest -UseBasicParsing -TimeoutSec 10 -Uri $env:API_HEALTH_URL
      #         if ($resp.StatusCode -ge 200 -and $resp.StatusCode -lt 500) {
      #           Write-Host "✅ API healthy (status $($resp.StatusCode))"
      #           exit 0
      #         }
      #         throw "Unexpected status code $($resp.StatusCode)"
      #       } catch {
      #         Write-Host "Attempt $i failed: $_"
      #         if ($i -eq $retries) { throw }
      #         Start-Sleep -Seconds 5
      #       }
      #     }

      # - name: Fail if health check failed
      #   if: steps.health_check.outcome == 'failure'
      #   shell: pwsh
      #   run: |
      #     Write-Error "❌ API health check failed after deployment"
      #     exit 1

      # - name: Download previous successful API artifact for rollback
      #   if: failure()
      #   id: download_previous_api
      #   continue-on-error: true
      #   uses: dawidd6/action-download-artifact@v6
      #   with:
      #     workflow: deploy-to-simply.yml
      #     workflow_conclusion: success
      #     name: api-publish
      #     path: ./rollback-api

      # - name: Roll back API using FTP
      #   if: failure() && steps.download_previous_api.outcome == 'success'
      #   uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      #   with:
      #     server: ${{ secrets.FTP_SERVER }}
      #     username: ${{ secrets.FTP_USERNAME }}
      #     password: ${{ secrets.FTP_PASSWORD }}
      #     local-dir: ./rollback-api/
      #     server-dir: /serioussez.api/
      #     dangerous-clean-slate: false

  deploy-web:
    runs-on: windows-latest
    needs: [detect-changes, build-web]
    if: needs.detect-changes.outputs.web == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Wait for API deployment if it was also changed
        if: needs.detect-changes.outputs.api == 'true'
        shell: pwsh
        run: |
          Write-Host "API and Web both changed - waiting for API deployment..."
          $maxRetries = 120
          $retryCount = 0

          while ($retryCount -lt $maxRetries) {
            try {
              $resp = Invoke-WebRequest -Uri "${{ env.API_HEALTH_URL }}" -UseBasicParsing -TimeoutSec 5
              if ($resp.StatusCode -eq 200) {
                Write-Host "✅ API is ready for Web deployment"
                exit 0
              }
            } catch {
              # API not ready yet, continue waiting
            }

            $retryCount++
            Start-Sleep -Seconds 2
          }

          Write-Warning "⚠️  API health check timed out - proceeding with Web deployment anyway"
          exit 0

      - name: Download Web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: ${{ env.ANGULAR_DIST_PATH }}/

      - name: Deploy Angular using FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ${{ env.ANGULAR_DIST_PATH }}/
          server-dir: /recipes/
          dangerous-clean-slate: false

      - name: Health check Web
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:WEB_HEALTH_URL)) {
            Write-Error "WEB_HEALTH_URL is not set"
          }
          Write-Host "Waiting 5 seconds for Web to start..."
          Start-Sleep -Seconds 5

          $retries = 5
          for ($i=1; $i -le $retries; $i++) {
            try {
              $resp = Invoke-WebRequest -UseBasicParsing -TimeoutSec 10 -Uri $env:WEB_HEALTH_URL
              if ($resp.StatusCode -ge 200 -and $resp.StatusCode -lt 500) {
                Write-Host "✅ Web healthy (status $($resp.StatusCode))"
                exit 0
              }
              throw "Unexpected status code $($resp.StatusCode)"
            } catch {
              Write-Host "Attempt $i failed: $_"
              if ($i -eq $retries) { throw }
              Start-Sleep -Seconds 5
            }
          }

  #     - name: Download previous successful Web artifact for rollback
  #       if: failure()
  #       id: download_previous_web
  #       continue-on-error: true
  #       uses: dawidd6/action-download-artifact@v6
  #       with:
  #         workflow: deploy-to-simply.yml
  #         workflow_conclusion: success
  #         name: web-dist
  #         path: ./rollback-web

  #     - name: Roll back Web using FTP
  #       if: failure() && steps.download_previous_web.outcome == 'success'
  #       uses: SamKirkland/FTP-Deploy-Action@v4.3.5
  #       with:
  #         server: ${{ secrets.FTP_SERVER }}
  #         username: ${{ secrets.FTP_USERNAME }}
  #         password: ${{ secrets.FTP_PASSWORD }}
  #         local-dir: ./rollback-web/
  #         server-dir: /recipes/
  #         dangerous-clean-slate: false
